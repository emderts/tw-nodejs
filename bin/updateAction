#!/usr/bin/env node

const { Pool } = require('pg');
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: true
}); 

const day = new Date().getDay();
const hour = new Date().getHours();
doWork();

async function doWork() {
try {
  const client = await pool.connect();
  if ((day >= 1 && day <= 5) || hour % 6 !== 0) {
    await client.query('update characters set actionPoint = actionPoint + 1 where actionPoint < 20');
  } else {
    await client.query('update characters set actionPoint = actionPoint + 3');
    await client.query('update characters set actionPoint = 20 where actionPoint > 20');
  }  
  if (hour == 0) {
  
    const result = await client.query('select * from characters');
    for (val of result.rows) {
      var charData = JSON.parse(val.char_data);
      if (day == 1) {
        delete charData.dayStoneBought;
        delete charData.actionBought;
      }
      charData.dungeonInfos.runMevious = false;
      charData.dungeonInfos.runEmberCrypt = false;
      await client.query('update characters set char_data = $1 where uid = $2', [JSON.stringify(charData), val.uid]);
    } 
  }
  client.release();  
  } catch (err) {
  }
  }